name: mobile-release

on:
  workflow_dispatch:
    inputs:
      track:
        description: Google Play track (internal/alpha/beta/production)
        default: internal
        required: true
      android:
        description: Build & upload Android bundle
        type: boolean
        default: true
      ios:
        description: Build & upload iOS ipa
        type: boolean
        default: false

jobs:
  android:
    if: ${{ github.event.inputs.android == 'true' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: mobile
    env:
      ANDROID_PACKAGE_NAME: ${{ secrets.ANDROID_PACKAGE_NAME }}
      GOOGLE_PLAY_TRACK: ${{ github.event.inputs.track }}
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
      - name: Install fastlane
        run: sudo gem install fastlane -NV
      - name: Configure Android signing & Play credentials
        env:
          ANDROID_KEYSTORE_B64: ${{ secrets.ANDROID_KEYSTORE_B64 }}
          ANDROID_KEYSTORE_PASS: ${{ secrets.ANDROID_KEYSTORE_PASS }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASS: ${{ secrets.ANDROID_KEY_PASS }}
          GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        run: |
          echo "$ANDROID_KEYSTORE_B64" | base64 -d > android/upload-keystore.jks
          cat <<'EOF' > android/key.properties
          storePassword=$ANDROID_KEYSTORE_PASS
          keyPassword=$ANDROID_KEY_PASS
          keyAlias=$ANDROID_KEY_ALIAS
          storeFile=upload-keystore.jks
          EOF
          echo "$GOOGLE_PLAY_SERVICE_ACCOUNT_JSON" > fastlane/play-account.json
      - name: Flutter pub get
        run: flutter pub get
      - name: Deploy Android via fastlane
        env:
          ANDROID_PACKAGE_NAME: ${{ secrets.ANDROID_PACKAGE_NAME }}
          GOOGLE_PLAY_TRACK: ${{ github.event.inputs.track }}
        run: fastlane android release

  ios:
    if: ${{ github.event.inputs.ios == 'true' }}
    runs-on: macos-latest
    defaults:
      run:
        working-directory: mobile
    env:
      IOS_BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
      - name: Install fastlane
        run: sudo gem install fastlane -NV
      - name: Configure Apple credentials
        env:
          APPLE_API_KEY_B64: ${{ secrets.APPLE_API_KEY_B64 }}
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
        run: |
          echo "$APPLE_API_KEY_B64" | base64 -d > fastlane/AuthKey.p8
      - name: Flutter pub get
        run: flutter pub get
      - name: Deploy iOS via fastlane
        env:
          IOS_BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
          APPLE_DEVELOPER_EMAIL: ${{ secrets.APPLE_DEVELOPER_EMAIL }}
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
        run: fastlane ios release
